<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Workload Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* THEME */
        :root {
            --brand-primary: #4a3aff;
            --brand-primary-2: #6254ff;
            --card-border: #2f2f2f;
            --elev-1: 0 4px 0 var(--card-border), 0 6px 16px rgba(0,0,0,0.12);
            --elev-1-hover: 0 5px 0 var(--card-border), 0 8px 18px rgba(0,0,0,0.18);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #66023c 0%, #cd1c18 100%);
            min-height: 100vh;
        }
        .filter-bar {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            padding: 0.5rem 0.75rem; 
            border: 2px solid var(--card-border);
            box-shadow: var(--elev-1);
        }
        /* Slimmer controls inside filter bar */
        .filter-bar label { font-size: 0.75rem; margin-bottom: 0.25rem; color: #4b5563; font-weight: 600; }
        .filter-item { display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 8px; }
        .label-inline { font-size: 0.75rem; font-weight: 700; color: #4b5563; white-space: nowrap; }
        .filter-bar input[type="date"], .filter-bar select {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 0.25rem 0.5rem;
            height: 36px;
            font-size: 0.875rem;
            width: 100%; /* will be controlled by grid column width */
        }
        @media (max-width: 768px) {
            .filter-item { grid-template-columns: 1fr; }
            .label-inline { margin-bottom: 0.25rem; }
            .filter-bar input[type="date"], .filter-bar select { width: 100%; }
        }

        /* Make the filter grid auto-fill the available width with a consistent min width */
        .filter-bar .grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .btn {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 700;
            color: white;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border: none;
            height: 44px;
        }
        .btn-primary {
            background: linear-gradient(145deg, var(--brand-primary), var(--brand-primary-2));
            box-shadow: 0 4px 0 #3027b3, 0 6px 12px rgba(74, 58, 255, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #3027b3, 0 8px 16px rgba(74, 58, 255, 0.4);
        }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 2px 0 #3027b3, 0 4px 8px rgba(74,58,255,0.2); }
        .btn-refresh {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            color: #333;
            border: 1px solid #ddd;
            box-shadow: 0 4px 0 #c0c0c0, 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-refresh:hover { transform: translateY(-1px); box-shadow: 0 5px 0 #c0c0c0, 0 8px 16px rgba(0,0,0,0.15); }
        .btn-refresh:active { transform: translateY(2px); box-shadow: 0 2px 0 #c0c0c0, 0 4px 8px rgba(0,0,0,0.1); }
        .btn-secondary {
            background: linear-gradient(145deg, #ffffff, #f6f6f6);
            color: #374151;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 3px 0 #bfbfbf, 0 5px 12px rgba(0,0,0,0.08);
        }
        .btn-secondary:hover { transform: translateY(-1px); }

        .kpi-group {
            background: rgba(255,255,255,0.2);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.35);
            overflow: hidden;
            backdrop-filter: blur(2px);
        }
        .kpi-group-header {
            background: rgba(153, 27, 27, 0.95);
            color: #fff;
            padding: 0.75rem 1.25rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .kpi-grid {
            padding: 1.25rem;
            display: grid;
            gap: 1.25rem;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* lock 2 columns */
        }
        @media (max-width: 480px) { .kpi-grid { grid-template-columns: 1fr; } }
        .kpi-item {
            position: relative;
            background: linear-gradient(145deg, #ffffff, #f6f6f6);
            padding: 12px 10px;
            border-radius: 16px;
            border: 2px solid var(--card-border);
            box-shadow: var(--elev-1);
            transition: all 0.2s ease;
            cursor: default;
            height: 74px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .kpi-item:hover { transform: translateY(-1px); box-shadow: var(--elev-1-hover); }
        .kpi-title {
            color: #666;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
        }
        .kpi-value {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.05;
        }
        .value-positive { background: linear-gradient(45deg, #23a6d5, #23d5ab) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; }
        .value-negative { background: linear-gradient(45deg, #e74c3c, #f39c12) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; }
        .chart-card {
            background: rgba(255,255,255,0.98);
            border-radius: 16px;
            border: 2px solid var(--card-border);
            box-shadow: var(--elev-1);
        }
        .chart-card:hover { transform: translateY(-1px); box-shadow: var(--elev-1-hover); }
        .chart-header {
            color: #111827;
            font-weight: 800;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        .no-data-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6b7280;
            font-style: italic;
        }
        .loader {
            border: 5px solid #e5e7eb;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 lg:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-80 flex flex-col justify-center items-center z-50 transition-opacity duration-300" style="display: none;">
        <div class="loader"></div>
        <p id="loading-text" class="text-gray-700 mt-4 text-lg">Loading data...</p>
    </div>

    <div class="container mx-auto max-w-screen-2xl">
        <header class="mb-6 flex items-end gap-3">
            <div class="filter-bar flex-1">
                <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="filter-item">
                        <label for="start-date" class="label-inline">Start Date</label>
                        <input type="date" id="start-date" class="bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none w-full">
                    </div>
                    <div class="filter-item">
                        <label for="end-date" class="label-inline">End Date</label>
                        <input type="date" id="end-date" class="bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none w-full">
                    </div>
                    <div class="filter-item">
                        <label for="center-filter" class="label-inline">Center</label>
                        <select id="center-filter" class="bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none disabled:opacity-50 w-full"></select>
                    </div>
                    <div class="filter-item">
                        <label for="subject-filter" class="label-inline">Subject</label>
                        <select id="subject-filter" class="bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none disabled:opacity-50 w-full" disabled></select>
                    </div>
                    <div class="filter-item">
                        <label for="teacher-filter" class="label-inline">Teacher</label>
                        <select id="teacher-filter" class="bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none disabled:opacity-50 w-full" disabled></select>
                    </div>
                </div>
            </div>
            <div id="header-actions" class="flex flex-row gap-2 shrink-0">
                <button id="export-report-button" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Export Report
                </button>
                <button id="reset-button" class="btn btn-refresh">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
                    Reset
                </button>
            </div>
        </header>

        <main>
            <div id="kpi-groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-card">
                    <h3 id="underutilized-title" class="chart-header">Underutilized Faculty</h3>
                    <div id="underutilized-faculty-list" class="p-4 overflow-y-auto" style="max-height: 600px;">
                        </div>
                </div>
                <div class="chart-card">
                    <h3 id="overutilized-title" class="chart-header">Overutilized Faculty</h3>
                    <div id="overutilized-faculty-list" class="p-4 overflow-y-auto" style="max-height: 600px;">
                        </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <div class="chart-card lg:col-span-3">
                    <h3 class="chart-header">Planned vs. Taken Classes by Center</h3>
                    <div class="p-4 relative h-96">
                        <canvas id="classesByCenterChart"></canvas>
                        <div id="classesByCenterChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
                <div class="chart-card lg:col-span-2">
                    <h3 class="chart-header">Hours Analysis</h3>
                     <div class="p-4 relative h-96">
                        <canvas id="hoursChart"></canvas>
                        <div id="hoursChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="chart-card">
                    <h3 class="chart-header">"Go-To" Substitutes</h3>
                    <div class="p-4 relative h-96">
                        <canvas id="substitutesChart"></canvas>
                        <div id="substitutesChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
                 <div class="chart-card">
                    <h3 class="chart-header">Faculty Cancellation Hotspot</h3>
                    <div class="p-4 relative h-96">
                        <canvas id="cancellationHotspotChart"></canvas>
                        <div id="cancellationHotspotChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-card">
                    <h3 class="chart-header">Cancellation/Substitution Trend</h3>
                    <div class="p-4 relative h-96">
                        <canvas id="trendChart"></canvas>
                        <div id="trendChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-header">Cancellation Rate (%) by Center</h3>
                    <div class="p-4 relative h-96">
                        <canvas id="centerCancellationRateChart"></canvas>
                        <div id="centerCancellationRateChart-no-data" class="no-data-message hidden">No data available</div>
                    </div>
                </div>
            </div>

             <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="chart-card">
                    <div class="chart-header sticky top-0 z-10 bg-white">
                        <span id="utilization-chart-title">Faculty Utilization</span>
                        <button id="export-utilization-csv" class="btn btn-secondary">Export CSV</button>
                    </div>
                    <div id="utilization-chart-container" class="p-4 relative overflow-y-auto" style="height: 600px;">
                        <div id="utilization-chart-wrapper" class="relative">
                            <canvas id="utilizationChart"></canvas>
                        </div>
                         <div id="utilizationChart-no-data" class="no-data-message hidden absolute inset-0">No data available</div>
                    </div>
                </div>
            </div>

            <div class="mt-8 mb-4 flex justify-center">
                <button id="logout-button" class="btn btn-refresh">Logout</button>
            </div>

        </main>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const GITHUB_USERNAME = 'rajnishpandey21';
        const GITHUB_REPO = 'fac_workload_gew';
        const GITHUB_BRANCH = 'main';
        const MONTHLY_HOURS_TARGET = 100;
        
        // --- AUTH SESSION ---
        const SESSION_STORAGE_KEY = 'fw_session';
        function getSession() {
            try {
                const raw = sessionStorage.getItem(SESSION_STORAGE_KEY);
                if (!raw) return null;
                const session = JSON.parse(raw);
                if (!session) return null;
                if (session.role === 'center' && session.center) return session;
                if (session.role === 'admin') return session;
                return null;
            } catch (e) {
                return null;
            }
        }
        const SESSION = getSession();
        if (!SESSION) {
            window.location.replace('index.html');
        }
        // Teachers to exclude from frontend (case-insensitive, trimmed)
        const EXCLUDED_TEACHER_NAMES = [
            'Prashant Kumar',
            'Satya Raj Jaiswal',
            'Debasish Mallick',
            'Abhishek Kumar Srivastav',
            'Kunal Kishor Mishra',
            'Sanjay Kumar Jat',
            'Nipen Paul',
            'Ravindra Tripathi',
            'Munna Kumar Singh',
            'Atul Singh',
            'Santosh Kumar',
            'Soumi Sarkar',
            'Piyush Rai',
            'Santosh Kumar SIngh',
            'Abhishek Rajoria',
            'Atul Sigh',
            'Gyanendra Singh',
            'Kapil Dev Gautam',
            'Kapil Kushwah',
            'Manvir Singh',
            'Mohan Singh Choudhary',
            'Muskan Sharma',
            'Ravindra Kumar Tripathi',
            'Ritwika Chakraborty',
            'Sandip Sen',
            'Saurabh Kumar Gautam',
            'Shweta Jaiswal',
            'Sonpal Jadon',
            'Soumya Chakraborty',
            'Subhankar Kumar Dey',
            'Vineet Dwivedi',
            'Vivek Kumar Tiwari',
            'Vivek Singh',
            'Amit Sahani',
            'Deependra Singh',
            'Kajal Ladia',
            'Nirbhay Yadav'
        ];

        // Provided Employee Code Database (code, name)
        const EMPLOYEE_CODE_ENTRIES = [
            ['PW26155','Hari Narayan Mishra'],
            ['PW23206','Ankit Raman'],
            ['PW24059','Shivendra Mishra'],
            ['PW15508','Himanshi Kaushik'],
            ['PW25864','Parul Sharma'],
            ['PW25751','Shobhit Gupta'],
            ['PW25980','Praveen Kumar Sharma'],
            ['PW27740','Bhuvnesh Pratap Singh'],
            ['PW29369','Amit Kumar Singh'],
            ['PW26764','Ankit Kumar'],
            ['LB','Sanjay Singh'],
            ['PW28550','Satya Raj Jaiswal'],
            ['PW27415','Mukesh Namdeo'],
            ['PW28767','Vikash Gupta'],
            ['PW28710','Santosh Kumar Kushwaha'],
            ['PW24631','Preeti Brakhane'],
            ['PW28140','Trapti Rathore'],
            ['PW28188','Sunil Rajput'],
            ['PW28186','Om Prakash Chandel'],
            ['PW28319','Pawan Mishra'],
            ['PW28575','Laxmi Mishra'],
            ['PW28241','Laxmikant Dwivedi'],
            ['PW27026','Debasish Mallick'],
            ['PW26287','Avisek Das'],
            ['PW27921','Subrat Kumar Pati'],
            ['PW28163','Bijay Kumar Sahoo'],
            ['PW27316','Amita Pal'],
            ['PW27856','Trupti Bala Nayak'],
            ['PW27882','Sanjib Kumar Debta'],
            ['PW27881','Prabhaba Mahapatra'],
            ['PW27880','Malaya Kumar Prusty'],
            ['PW28202','Sandeep Sammader'],
            ['PW27895','Bhabani Sankar Das'],
            ['LB','Swayanjeet Behera'],
            ['PW26598','Abhishek Kumar Srivastav'],
            ['PW26721','Abhimanyu Singh'],
            ['PW26284','Adarsh Pandey'],
            ['PW25820','Aayush Kanwar'],
            ['PW24816','Shweta'],
            ['PW26232','Manju Kumari'],
            ['PW28010','Nitish Chona'],
            ['PW27916','Rohan Mishra'],
            ['PW28008','Manish Mishra'],
            ['PW28009','Amit Kumar Sharma'],
            ['PW28011','Abhishek Kumar Pandey'],
            ['PW27420','Shahid Jamal'],
            ['PW23460','Kunal Kishor Mishra'],
            ['PW23402','Shivansh Bhargava'],
            ['PW16136','Rajdeep Singh Bundela'],
            ['PW23364','Manendra Kumar Dwivedi'],
            ['PW25310','Diksha Bawniya'],
            ['PW23286','Shivani Tomar'],
            ['PW27434','Talha Khan'],
            ['PW28629','Shubham Maurya'],
            ['PW28689','Kapil Patel'],
            ['PW28627','Dheer Singh'],
            ['PW28559','Alekh Pandey'],
            ['PW25758','Prashant Shishodia'],
            ['PW25736','Sagar Sharma'],
            ['PW25755','Manish Gupta'],
            ['LB','Deependra Pratap Singh'],
            ['PW25759','Vishal Hasmukh'],
            ['PW28921','Kapil Dubey'],
            ['LB','Dharmendra Sinha'],
            ['LB','Abhishek Rawat'],
            ['LB','Jay Bairagi'],
            ['PW28167','Sanjay Kumar Jat'],
            ['PW23507','Gaurav Inpatiya'],
            ['PW27534','Aman Sonkar'],
            ['PW23601','Khusbu Kumawat'],
            ['PW29334','Churchika Shaktawat'],
            ['PW29470','Sandeep Mahala'],
            ['PW25737','Devendra Kumar'],
            ['PW25739','Ranjeet Singh'],
            ['PW25745','Abhishek Kumar Singh'],
            ['PW27386','Saurabh Mathur'],
            ['PW25754','Jai Kishan'],
            ['LB','Pooja Jaiswal'],
            ['PW22918','Nipen Paul'],
            ['PW17591','Sumit Adak'],
            ['PW15933','Suman Roy'],
            ['PW16423','Inzmam Ul Haque'],
            ['PW18107','Richa Halder'],
            ['PW20548','Lina Mondal'],
            ['PW20638','Anisha Ghosh'],
            ['PW25789','Milton Kundu'],
            ['PW25780','Sankar Das'],
            ['PW25779','Amritendu Moitra'],
            ['PW25790','Subhro Kundu'],
            ['PW25791','Jeetu Tiwari'],
            ['PW25792','Ranjan Kumar Kundu'],
            ['PW13235','Subhankar Dey'],
            ['LB','Prasenjit Saha'],
            ['LB','Debarka Nandy'],
            ['LB','Rajib Chakraborty'],
            ['LB','Shubhra Jyoti Dutta'],
            ['LB','Ms Sutapa Dutta'],
            ['LB','Priyanka Dey'],
            ['PW15216','Ravindra Tripathi'],
            ['PW15511','Vimal Singh Yadav'],
            ['PW26956','Akhilesh Pandey'],
            ['PW23634','Prakhar Jaiswal'],
            ['PW17869','Sonali Verma'],
            ['PW21627','Mamta Gupta'],
            ['PW25105','Mamta Patel'],
            ['PW25773','Kriti Gupta'],
            ['PW25794','Ahindra Dwivedi'],
            ['PW25996','Nitin Kumar Bajpai'],
            ['PW25761','Anuj Kumar Yadav'],
            ['PW25793','Piyush Chauhan'],
            ['PW25795','Rohit Verma'],
            ['PW23974','Gaurav Prakhar'],
            ['PW25796','Gaurav Kumar'],
            ['PW26149','Shubham Kumar Verma'],
            ['LB','Anjan Kumar'],
            ['PW25797','Dharmendra Ojha'],
            ['LB','Krishna Murari'],
            ['PW26092','Deepak Singh'],
            ['PW21431','Munna Kumar Singh'],
            ['PW20398','Rajnish Singh'],
            ['PW21702','Satyam Kumar Choudhary'],
            ['PW29220','Chandan Kumar'],
            ['PW27800','Lalit Kumar Sah'],
            ['PW21797','Jyoti Kumari'],
            ['PW20416','Amana Prachi'],
            ['PW22180','Nidhi Kumari'],
            ['PW25769','Kunal Pathak'],
            ['PW27640','Bipin Kumar Singh'],
            ['PW24628','Abhishek Kishore'],
            ['PW25767','Ram Awadhesh Singh'],
            ['PW27749','Rahul Mishra'],
            ['PW25764','Kush Kumar Pathak'],
            ['PW28585','Abhishek Kumar'],
            ['PW25768','Diwakar Choudhary'],
            ['PW25766','Pushpanjali'],
            ['LB','Kundan Kapoor'],
            ['LB','Deepak Kumar'],
            ['PW22944','Atul Singh'],
            ['PW26737','Gaurav Kumar Srivastava'],
            ['PW22842','Shobhit Nayak'],
            ['PW17942','Ravindra Shukla'],
            ['PW22878','Poonam Singh'],
            ['PW22930','Sonali Singh'],
            ['PW25762','Mantu Kumar'],
            ['PW25757','Ankit Singh Senger'],
            ['PW25763','Vibhav Singh'],
            ['PW27783','Jeet Singh'],
            ['PW25760','Sourabh Mishra'],
            ['PW29944','Samar Bahadur Yadav'],
            ['LB','Kaushal Kishore'],
            ['LB','Nitin Kumar'],
            ['LB','Rajkumar Yadav'],
            ['PW29377','Yagyanivas'],
            ['PW29046','Prince Kumar Pandey'],
            ['PW28625','Rishi Kant'],
            ['PW28623','Pavan Kumar Bhartiya'],
            ['PW28624','Preetam Singh'],
            ['PW23517','Pallavi Singh'],
            ['PW28628','Gargi Mishra'],
            ['PW28630','Ajit Kumar Maurya'],
            ['PW28621','Rahul Kumar Rai'],
            ['PW28626','Hari Shankar Yadav'],
            ['PW28622','Amar Jyoti Singh'],
            ['PW28619','Abhinav Mishra'],
            ['PW28620','Rakesh Kumar'],
            ['PW28692','Abhay Singh'],
            ['PW28547','Jail Singh Yadav'],
            ['PW28587','Gautam Kumar Verma'],
            ['PW28548','Dhananjay Kumar Yadav'],
            ['PW28546','Sanjay Kumar Sharma'],
            ['PW28544','Hemant Kushwaha'],
            ['PW28561','Mr. Vivek Singh'],
            ['PW28549','Sudhir Singh'],
            ['PW28560','Shashi Bhushan Singh'],
            ['LB','Manish Kumar Mishra'],
            ['PW23549','Santosh Kumar'],
            ['PW23681','Uma Kant'],
            ['PW24386','Sanjay Kumar'],
            ['PW28442','Madhu'],
            ['PW23713','Akriti Arun'],
            ['PW23508','Chetan Sharma'],
            ['PW25748','Pradip Kumar Upadhyay'],
            ['PW25746','Amarnath Dwivedi'],
            ['PW25749','Alok Ranjan Choubey'],
            ['PW25747','Saket Kumar'],
            ['PW25744','Pravin Choubey'],
            ['PW25740','Binod Kumar Swarnkar'],
            ['PW24441','Soumi Sarkar'],
            ['PW23816','Rajdwip Das'],
            ['PW23578','Prantik Basak'],
            ['PW27273','Pankaj Debnath'],
            ['PW27249','Jayeeta Das'],
            ['PW26269','Payel Shil'],
            ['PW28012','Suman Mahato'],
            ['PW26243','Tapas Dolui'],
            ['PW29401','Arindam Hazra'],
            ['PW26278','Sandip Dhara'],
            ['LB','Anik Misra'],
            ['LB','Samriddhi Bagchi'],
            ['PW24992','Piyush Rai'],
            ['PW23537','Bhagwan Ji Gupta'],
            ['PW23947','Rahul Kumar'],
            ['PW23515','Vikash Dubey'],
            ['PW23536','Veena Rai'],
            ['PW28336','Dipika Tripathi'],
            ['PW25734','Jaswant Singh'],
            ['PW25742','Brijesh Kumar Singh Baghel'],
            ['PW25738','Hemant Kumar Mishra'],
            ['PW25752','Anirudha Kumar Mishra'],
            ['PW25770','Amit Mishra'],
            ['LB','Vipin Shukla'],
            ['LB','Sandeep Kumar Pandey']
        ];
        
        // --- PLUGIN REGISTRATION (DO ONCE) ---
        Chart.register(ChartDataLabels);
        // Chart.js theme defaults
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#374151';
        Chart.defaults.animation.duration = 1200;
        Chart.defaults.animation.easing = 'easeInOutQuart';

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const centerFilter = document.getElementById('center-filter');
        const subjectFilter = document.getElementById('subject-filter');
        const teacherFilter = document.getElementById('teacher-filter');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const resetButton = document.getElementById('reset-button');
        const exportReportButton = document.getElementById('export-report-button');
        const kpiGroupsContainer = document.getElementById('kpi-groups-container');
        const underutilizedListContainer = document.getElementById('underutilized-faculty-list');
        const underutilizedTitle = document.getElementById('underutilized-title');
        const overutilizedListContainer = document.getElementById('overutilized-faculty-list');
        const overutilizedTitle = document.getElementById('overutilized-title');
        const utilizationChartTitle = document.getElementById('utilization-chart-title');
        const exportUtilizationButton = document.getElementById('export-utilization-csv');
        const logoutButton = document.getElementById('logout-button');

        // --- GLOBAL STATE ---
        let masterData = [];
        let uniqueTeachersByCenter = {};
        let uniqueSubjectsByCenter = {};
        let teachersByCenterSubject = {};
        let teachersBySubject = {};
        let chartInstances = {};
        let utilizationDataForExport = [];
        let lastFilteredData = [];

        // --- UTILITY FUNCTIONS ---
        const normalizeName = (name) => {
            if (name === undefined || name === null) return '';
            return String(name).trim().toLowerCase();
        };
        const formatNumber = (num) => isNaN(num) ? '0' : num.toLocaleString('en-IN');
        const formatPercent = (num) => isNaN(num) ? '0.0%' : `${num.toFixed(1)}%`;
        const safeParseFloat = (val) => {
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        };
        const EXCLUDED_TEACHERS = new Set(EXCLUDED_TEACHER_NAMES.map(n => normalizeName(n)).filter(Boolean));
        function shouldExcludeRow(row) {
            const original = normalizeName(row && row.faculty_name);
            const substitute = normalizeName(row && row.Substitute_Faculty_Name);
            if (EXCLUDED_TEACHERS.has(original) || EXCLUDED_TEACHERS.has(substitute)) return true;
            if (isLBTeacherName(row && row.faculty_name)) return true;
            if (isLBTeacherName(row && row.Substitute_Faculty_Name)) return true;
            return false;
        }
        // Center name normalization mapping to merge aliases
        const CENTER_SYNONYMS = new Map([
            ['prayagraj lkt', 'Prayagraj']
        ]);
        function getCanonicalCenterName(center) {
            if (!center) return '';
            const trimmed = String(center).trim();
            const alias = CENTER_SYNONYMS.get(trimmed.toLowerCase());
            return alias || trimmed;
        }
        // Build name -> employee code map and helpers for display labels
        const NAME_TO_EMPLOYEE_CODE = new Map(EMPLOYEE_CODE_ENTRIES.map(([code, name]) => [normalizeName(String(name).replace(/\.$/, '')), code]));
        function getEmployeeCodeForName(name) {
            if (!name) return null;
            const normalized = normalizeName(String(name).replace(/\.$/, ''));
            const code = NAME_TO_EMPLOYEE_CODE.get(normalized);
            if (!code) return null;
            return code;
        }
        function formatTeacherForDisplay(name) {
            const code = getEmployeeCodeForName(name);
            return code ? `${name} - (${code})` : `${name}`;
        }
        function isLBTeacherName(name) {
            const code = getEmployeeCodeForName(name);
            return code === 'LB';
        }
        
        function toggleNoDataMessage(chartId, hasData) {
            const chartWrapper = document.getElementById(`${chartId}-wrapper`);
            const canvas = document.getElementById(chartId);
            const noDataEl = document.getElementById(`${chartId}-no-data`);
            
            const targetCanvas = chartWrapper ? chartWrapper : canvas;

            if (targetCanvas && noDataEl) {
                targetCanvas.style.display = hasData ? 'block' : 'none';
                noDataEl.style.display = hasData ? 'none' : 'flex';
            }
        }

        // --- DATA LOADING & PREPROCESSING ---
        async function loadData() {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            try {
                const manifestUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${GITHUB_BRANCH}/manifest.json`;
                const manifestResponse = await fetch(`${manifestUrl}?cachebust=${new Date().getTime()}`);
                if (!manifestResponse.ok) throw new Error(`Could not fetch manifest.json. Status: ${manifestResponse.status}.`);
                const manifest = await manifestResponse.json();

                loadingText.textContent = `Loading ${manifest.file_list.length} data file(s)...`;

                const filePromises = manifest.file_list.map(fileName => {
                    const fileUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${GITHUB_BRANCH}/${fileName}`;
                    return fetch(`${fileUrl}?cachebust=${new Date().getTime()}`).then(res => res.json());
                });

                masterData = (await Promise.all(filePromises)).flat();
                // Frontend exclusion: drop rows where either original or substitute teacher is in the blocked list
                masterData = masterData.filter(r => !shouldExcludeRow(r));
                // Normalize center names (e.g., merge 'Prayagraj LKT' into 'Prayagraj')
                masterData = masterData.map(r => ({ ...r, branch_name: getCanonicalCenterName(r && r.branch_name) }));
                
                if (masterData.length > 0) {
                   preprocessData();
                   populateFilters();
                   setDefaultDates();
                   updateDashboard();
                } else {
                   loadingText.textContent = 'No data found.';
                }
                

            } catch (error) {
                console.error("FATAL ERROR during data load:", error);
                loadingText.innerHTML = `Failed to load data.<br/><small>${error.message}</small>`;
            } finally {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            }
        }
        
        function preprocessData() {
            // Reset aggregations
            uniqueTeachersByCenter = {};
            uniqueSubjectsByCenter = {};
            teachersByCenterSubject = {};
            teachersBySubject = {};

            const allTeachers = new Set();
            const allSubjects = new Set();

            masterData.forEach(row => {
                const center = row && row.branch_name ? String(row.branch_name).trim() : '';
                const subject = row && row.Expertise ? String(row.Expertise).trim() : '';
                if (center) {
                    const originalTeacher = row.faculty_name;
                    const subTeacher = row.Substitute_Faculty_Name;

                    if (!uniqueTeachersByCenter[center]) uniqueTeachersByCenter[center] = new Set();
                    if (!uniqueSubjectsByCenter[center]) uniqueSubjectsByCenter[center] = new Set();
                    if (!teachersByCenterSubject[center]) teachersByCenterSubject[center] = {};
                    
                    if (subject) {
                        uniqueSubjectsByCenter[center].add(subject);
                        allSubjects.add(subject);
                        if (!teachersByCenterSubject[center][subject]) teachersByCenterSubject[center][subject] = new Set();
                    }

                    if (originalTeacher && String(originalTeacher).trim() && !isLBTeacherName(originalTeacher)) {
                        const normalizedOriginal = normalizeName(originalTeacher);
                        if (!EXCLUDED_TEACHERS.has(normalizedOriginal)) {
                            const trimmedOriginal = String(originalTeacher).trim();
                            uniqueTeachersByCenter[center].add(trimmedOriginal);
                            allTeachers.add(trimmedOriginal);
                            if (subject) {
                                if (!teachersBySubject[subject]) teachersBySubject[subject] = new Set();
                                teachersBySubject[subject].add(trimmedOriginal);
                                teachersByCenterSubject[center][subject]?.add(trimmedOriginal);
                            }
                        }
                    }
                    if (subTeacher && String(subTeacher).trim() && !isLBTeacherName(subTeacher)) {
                        const normalizedSub = normalizeName(subTeacher);
                        if (!EXCLUDED_TEACHERS.has(normalizedSub)) {
                            const trimmedSub = String(subTeacher).trim();
                            uniqueTeachersByCenter[center].add(trimmedSub);
                            allTeachers.add(trimmedSub);
                            if (subject) {
                                if (!teachersBySubject[subject]) teachersBySubject[subject] = new Set();
                                teachersBySubject[subject].add(trimmedSub);
                                teachersByCenterSubject[center][subject]?.add(trimmedSub);
                            }
                        }
                    }
                }
            });
            uniqueTeachersByCenter['all'] = allTeachers;
            uniqueSubjectsByCenter['all'] = allSubjects;
        }
        
        // --- FILTERS ---
        function populateFilters() {
            const baseCenters = Object.keys(uniqueTeachersByCenter).filter(c => c !== 'all').sort();
            const rawDefaultCenter = (SESSION && SESSION.role === 'center') ? SESSION.center : 'all';
            const defaultCenterValue = rawDefaultCenter === 'all' ? 'all' : getCanonicalCenterName(rawDefaultCenter);
            if (defaultCenterValue !== 'all' && !baseCenters.includes(defaultCenterValue)) {
                baseCenters.push(defaultCenterValue);
                baseCenters.sort();
            }
            const centers = ['All Centers', ...baseCenters];
            centerFilter.innerHTML = centers.map(c => `<option value="${c === 'All Centers' ? 'all' : c}">${c}</option>`).join('');
            centerFilter.value = defaultCenterValue;
            centerFilter.disabled = (SESSION && SESSION.role === 'center'); // Lock for center users only
            populateSubjectFilter();
            populateTeacherFilter();
        }

        function populateSubjectFilter() {
            const selectedCenter = centerFilter.value;
            const subjects = Array.from(uniqueSubjectsByCenter[selectedCenter] || []).sort();
            subjectFilter.innerHTML = `<option value="all">All Subjects</option>` + subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            subjectFilter.disabled = subjects.length === 0;
        }

        function populateTeacherFilter() {
            const selectedCenter = centerFilter.value;
            const selectedSubject = subjectFilter ? subjectFilter.value : 'all';

            let teacherSet;
            if (selectedCenter !== 'all' && selectedSubject !== 'all') {
                teacherSet = teachersByCenterSubject[selectedCenter]?.[selectedSubject] || new Set();
            } else if (selectedCenter !== 'all' && selectedSubject === 'all') {
                teacherSet = uniqueTeachersByCenter[selectedCenter] || new Set();
            } else if (selectedCenter === 'all' && selectedSubject !== 'all') {
                teacherSet = teachersBySubject[selectedSubject] || new Set();
            } else {
                teacherSet = uniqueTeachersByCenter['all'] || new Set();
            }

            const teachers = Array.from(teacherSet).sort();
            teacherFilter.innerHTML = `<option value="all">All Teachers</option>` + teachers.map(t => `<option value="${t}">${formatTeacherForDisplay(t)}</option>`).join('');
            teacherFilter.disabled = teachers.length === 0;
        }
        
        function setDefaultDates(){
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startDateInput.valueAsDate = firstDayOfMonth;
            endDateInput.valueAsDate = today;
        }
        
        function resetFiltersAndReload() {
            setDefaultDates();
            const defaultCenterValue = (SESSION && SESSION.role === 'center') ? SESSION.center : centerFilter.value || 'all';
            centerFilter.value = defaultCenterValue;
            populateSubjectFilter();
            subjectFilter.value = 'all';
            populateTeacherFilter();
            teacherFilter.value = 'all';
            updateDashboard();
        }

        function logout() {
            try { sessionStorage.removeItem(SESSION_STORAGE_KEY); } catch (e) {}
            window.location.replace('index.html');
        }

        // --- CORE DASHBOARD LOGIC ---
        function updateDashboard() {
            const { startDate, endDate, center, subject, teacher } = getFilterValues();
            const filteredData = filterData(startDate, endDate, center, subject, teacher);
            lastFilteredData = filteredData;
            
            const kpis = calculateKPIs(filteredData);
            renderKPIs(kpis);
            
            renderAllChartsAndLists(filteredData, startDate, endDate);
        }

        function getFilterValues() {
            return {
                startDate: startDateInput.value,
                endDate: endDateInput.value,
                center: centerFilter.value,
                subject: subjectFilter.value,
                teacher: teacherFilter.value,
            };
        }
        
        function filterData(startDateStr, endDateStr, center, subject, teacher) {
            return masterData.filter(row => {
                if (!row.LectureDate) return false;
                
                const lectureDateObj = new Date(row.LectureDate);
                if (isNaN(lectureDateObj.getTime())) return false;

                const localDate = new Date(lectureDateObj.getTime() - (lectureDateObj.getTimezoneOffset() * 60000));
                const lectureDateStr = localDate.toISOString().split('T')[0];

                const isDateMatch = lectureDateStr >= startDateStr && lectureDateStr <= endDateStr;
                const rowCenter = getCanonicalCenterName(row.branch_name || '');
                const isCenterMatch = center === 'all' || rowCenter === center;
                const rowSubject = row.Expertise ? String(row.Expertise).trim() : '';
                const isSubjectMatch = subject === 'all' || rowSubject === subject;
                
                let actualTeacher = row.Status === 'Substitute' ? row.Substitute_Faculty_Name : row.faculty_name;
                actualTeacher = actualTeacher ? String(actualTeacher).trim() : null;

                const isTeacherMatch = teacher === 'all' || actualTeacher === teacher;
                
                return isDateMatch && isCenterMatch && isSubjectMatch && isTeacherMatch;
            });
        }
        
        function calculateKPIs(data) {
            const plannedClasses = data.length;
            const cancelledClasses = data.filter(r => r.Status === 'Cancellation').length;
            const substituteClasses = data.filter(r => r.Status === 'Substitute').length;
            const takenClasses = plannedClasses - cancelledClasses;

            const cancelledHours = data.filter(r => r.Status === 'Cancellation').reduce((sum, r) => sum + safeParseFloat(r.LectureDuration), 0);
            const plannedHours = data.reduce((sum, r) => sum + safeParseFloat(r.LectureDuration), 0);
            const taughtHours = plannedHours - cancelledHours;

            const takenData = data.filter(r => r.Status !== 'Cancellation');
            const paidLectures = takenData.filter(r => r.Payment === 'Paid').length;
            const freeLectures = takenClasses - paidLectures;
            const totalFreeLectures = freeLectures;

            // Demo vs Other breakdown within Free
            const demoFreeLectures = takenData.filter(r => String(r.Payment).trim() === 'Free' && String(r.Expertise || '').trim().toLowerCase() === 'demo').length;
            const otherFreeLectures = Math.max(0, totalFreeLectures - demoFreeLectures);
            const otherFreePercent = totalFreeLectures > 0 ? (otherFreeLectures / totalFreeLectures) * 100 : 0;
            
            return {
                plannedClasses, takenClasses,
                takenClassesPercent: plannedClasses > 0 ? (takenClasses / plannedClasses) * 100 : 0,
                substituteClasses,
                substituteClassesPercent: plannedClasses > 0 ? (substituteClasses / plannedClasses) * 100 : 0,
                cancelledClasses, // "Cancelled but not Substituted"
                cancellationPercent: plannedClasses > 0 ? (cancelledClasses / plannedClasses) * 100 : 0,
                plannedHours, taughtHours, cancelledHours,
                cancelledHoursPercent: plannedHours > 0 ? (cancelledHours / plannedHours) * 100 : 0,
                paidLectures, freeLectures,
                freeLecturesPercent: takenClasses > 0 ? (freeLectures / takenClasses) * 100 : 0,
                totalFreeLectures, demoFreeLectures, otherFreeLectures, otherFreePercent
            };
        }

        // Returns CSS class name for KPI value accenting based on thresholds
        function getKpiClass(key, kpis) {
            const value = Number(kpis[key]);
            if (!isFinite(value)) return '';
            // Thresholds tuned for faculty workload context
            const rules = {
                takenClassesPercent: { dir: 'high', good: 95 },
                substituteClassesPercent: { dir: 'low', good: 5 },
                cancellationPercent: { dir: 'low', good: 5 },
                cancelledHoursPercent: { dir: 'low', good: 5 },
                freeLecturesPercent: { dir: 'low', good: 20 }
            };
            const rule = rules[key];
            if (!rule) return '';
            const isGood = rule.dir === 'high' ? value >= rule.good : value <= rule.good;
            return isGood ? 'value-positive' : 'value-negative';
        }

        function renderKPIs(kpis) {
            const groups = [
                {
                    title: 'Classes Performance',
                    items: [
                        { key: 'plannedClasses', title: 'Plan Classes', value: formatNumber(kpis.plannedClasses), tooltip: 'Total classes scheduled in the selected period.' },
                        { key: 'takenClasses', title: 'Taken Classes', value: formatNumber(kpis.takenClasses), tooltip: 'Classes that were not cancelled (includes substituted classes).' },
                        { key: 'takenClassesPercent', title: 'Taken %', value: formatPercent(kpis.takenClassesPercent), tooltip: 'Percentage of planned classes that were actually taken.' }
                    ]
                },
                {
                    title: 'Cancel v/s Substitute',
                    items: [
                        { key: 'substituteClasses', title: 'Substituted', value: formatNumber(kpis.substituteClasses), tooltip: 'Classes taken by a different teacher than originally planned.' },
                        { key: 'substituteClassesPercent', title: 'Substituted %', value: formatPercent(kpis.substituteClassesPercent), tooltip: 'Percentage of planned classes that were substituted.' },
                        { key: 'cancelledClasses', title: 'Cancelled', value: formatNumber(kpis.cancelledClasses), tooltip: 'Classes that were cancelled and not substituted.' },
                        { key: 'cancellationPercent', title: 'Cancelled %', value: formatPercent(kpis.cancellationPercent), tooltip: 'Percentage of planned classes that were cancelled.' }
                    ]
                },
                {
                    title: 'Time Performance',
                    items: [
                        { key: 'plannedHours', title: 'Hours Planned', value: formatNumber(kpis.plannedHours.toFixed(1)), tooltip: 'Total hours scheduled in the selected period.' },
                        { key: 'taughtHours', title: 'Hours Taken', value: formatNumber(kpis.taughtHours.toFixed(1)), tooltip: 'Total hours taught (planned minus cancelled hours).' },
                        { key: 'cancelledHours', title: 'Cancel Hours', value: formatNumber(kpis.cancelledHours.toFixed(1)), tooltip: 'Total hours from cancelled classes.' },
                        { key: 'cancelledHoursPercent', title: 'Cancelled %', value: formatPercent(kpis.cancelledHoursPercent), tooltip: 'Percentage of planned hours that were cancelled.' }
                    ]
                },
                 {
                    title: 'Paid vs Free Analysis',
                    items: [
                        { key: 'takenClasses', title: 'Total Taken', value: formatNumber(kpis.takenClasses), tooltip: 'Total classes taken (paid + free).' },
                        { key: 'paidLectures', title: 'Paid Lectures', value: formatNumber(kpis.paidLectures), tooltip: 'Number of taken classes marked as "Paid".' },
                        { key: 'freeLectures', title: 'Free Lectures', value: formatNumber(kpis.freeLectures), tooltip: 'Number of taken classes not marked as "Paid".' },
                        { key: 'freeLecturesPercent', title: 'Free %', value: formatPercent(kpis.freeLecturesPercent), tooltip: 'Percentage of taken classes that were free.' }
                    ]
                },
                {
                    title: 'Demo vs Mock Analysis',
                    items: [
                        { key: 'totalFreeLectures', title: 'Free Lectures', value: formatNumber(kpis.totalFreeLectures), tooltip: 'All free lectures in the selected period.' },
                        { key: 'demoFreeLectures', title: 'Demo Free', value: formatNumber(kpis.demoFreeLectures), tooltip: 'Free lectures where subject is Demo.' },
                        { key: 'otherFreeLectures', title: 'Other Free', value: formatNumber(kpis.otherFreeLectures), tooltip: 'Free lectures that are not Demo.' },
                        { key: 'otherFreePercent', title: 'Other Free %', value: formatPercent(kpis.otherFreePercent), tooltip: 'Percentage of free lectures that are not Demo.' }
                    ]
                }
            ];

            kpiGroupsContainer.innerHTML = groups.map(group => `
                <div class="kpi-group">
                    <div class="kpi-group-header">${group.title}</div>
                    <div class="kpi-grid">
                        ${group.items.map(item => `
                            <div class="kpi-item" title="${item.tooltip}" data-kpi-key="${item.key}">
                                <div class="kpi-title">${item.title}</div>
                                <div class="kpi-value ${getKpiClass(item.key, kpis)}">${item.value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Attach click-to-export handlers
            const kpiItems = kpiGroupsContainer.querySelectorAll('.kpi-item');
            kpiItems.forEach(el => {
                el.addEventListener('click', () => {
                    const key = el.getAttribute('data-kpi-key');
                    exportKpiDatasetToCSV(key);
                });
                el.style.cursor = 'pointer';
            });
        }

        // --- KPI DATA EXPORT ---
        function exportKpiDatasetToCSV(kpiKey) {
            if (!lastFilteredData || lastFilteredData.length === 0) {
                alert('No data available for the selected filters.');
                return;
            }

            const rows = getRowsForKpi(kpiKey, lastFilteredData);
            if (!rows || rows.length === 0) {
                alert('No matching rows for this KPI.');
                return;
            }

            const filename = `${kpiKey}_${new Date().toISOString().split('T')[0]}.csv`;
            exportRowsToCSV(rows, filename);
        }

        function getRowsForKpi(kpiKey, rows) {
            const takenRows = rows.filter(r => r.Status !== 'Cancellation');
            const isFreePayment = (r) => String(r.Payment || '').trim() === 'Free';
            const isPaidPayment = (r) => String(r.Payment || '').trim() === 'Paid';
            const isDemo = (r) => String(r.Expertise || '').trim().toLowerCase() === 'demo';

            switch (kpiKey) {
                // Classes Performance
                case 'plannedClasses': return rows;
                case 'takenClasses':
                case 'takenClassesPercent': return takenRows;

                // Cancel vs Substitute
                case 'substituteClasses':
                case 'substituteClassesPercent': return rows.filter(r => r.Status === 'Substitute');
                case 'cancelledClasses':
                case 'cancellationPercent': return rows.filter(r => r.Status === 'Cancellation');

                // Time Performance
                case 'plannedHours': return rows;
                case 'taughtHours': return takenRows;
                case 'cancelledHours':
                case 'cancelledHoursPercent': return rows.filter(r => r.Status === 'Cancellation');

                // Paid vs Free
                case 'paidLectures': return takenRows.filter(isPaidPayment);
                case 'freeLectures':
                case 'freeLecturesPercent': return takenRows.filter(r => !isPaidPayment(r));

                // Demo vs Mock
                case 'totalFreeLectures': return takenRows.filter(r => !isPaidPayment(r));
                case 'demoFreeLectures': return takenRows.filter(r => isFreePayment(r) && isDemo(r));
                case 'otherFreeLectures':
                    return takenRows.filter(r => isFreePayment(r) && !isDemo(r));
                case 'otherFreePercent':
                    return takenRows.filter(r => isFreePayment(r) && !isDemo(r));

                default: return rows;
            }
        }

        function exportRowsToCSV(rows, filename) {
            const headers = [
                'Date','Center','Status','Original Teacher','Substitute Teacher','Subject','FacultyCode','Lecture Duration (Hrs)','Payment'
            ];
            const csvRows = [headers.join(',')];
            for (const r of rows) {
                const dateStr = r.LectureDate ? new Date(r.LectureDate).toLocaleDateString('en-CA') : '';
                const arr = [
                    dateStr,
                    quoteCSV(getCanonicalCenterName(r.branch_name)),
                    quoteCSV(r.Status),
                    quoteCSV(r.faculty_name),
                    quoteCSV(r.Substitute_Faculty_Name),
                    quoteCSV(r.Expertise),
                    quoteCSV(r.FacultyCode),
                    String(safeParseFloat(r.LectureDuration)),
                    quoteCSV(r.Payment)
                ];
                csvRows.push(arr.join(','));
            }
            const csvContent = 'data:text/csv;charset=utf-8,' + csvRows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function quoteCSV(val) {
            const s = (val === undefined || val === null) ? '' : String(val);
            if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                return '"' + s.replace(/"/g, '""') + '"';
            }
            return s;
        }
        
        // --- CHARTING & LISTS LOGIC ---
        function renderAllChartsAndLists(data, startDateStr, endDateStr) {
            try {
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                const diffTime = Math.abs(endDate - startDate);
                const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const monthCount = dayCount / 30.4375; // Average days in a month
                const proRatedUnderTarget = MONTHLY_HOURS_TARGET * monthCount;
                const OVER_MONTHLY_HOURS = 175; // criteria for overutilization per month
                const proRatedOverTarget = OVER_MONTHLY_HOURS * monthCount;

                const taughtHoursByTeacher = data
                    .filter(r => r.Status !== 'Cancellation')
                    .reduce((acc, curr) => {
                        const teacher = curr.Status === 'Substitute' ? curr.Substitute_Faculty_Name : curr.faculty_name;
                        const teacherName = teacher ? String(teacher).trim() : null;
                        if(teacherName) acc[teacherName] = (acc[teacherName] || 0) + safeParseFloat(curr.LectureDuration);
                        return acc;
                    }, {});

                renderUnderutilizedFaculty(data, proRatedUnderTarget, dayCount);
                renderOverutilizedFaculty(data, proRatedOverTarget, dayCount);
                renderClassesByCenterChart(data);
                renderHoursChart(data);
                renderSubstitutesLeaderboard(data);
                renderCancellationHotspot(data);
                renderTrendChart(data);
                renderCenterCancellationRate(data);
                renderUtilizationChart(taughtHoursByTeacher, proRatedUnderTarget);
                
                utilizationDataForExport = Object.entries(taughtHoursByTeacher).map(([name, totalHours]) => ({
                    name,
                    target: proRatedUnderTarget.toFixed(2),
                    achieved: totalHours.toFixed(2),
                    remark: totalHours >= proRatedUnderTarget ? 'Met Target' : 'Below Target'
                })).sort((a,b) => b.achieved - a.achieved);

            } catch (error) {
                console.error("FATAL ERROR during chart rendering:", error);
            }
        }

        function renderUnderutilizedFaculty(data, proRatedTarget, dayCount) {
            underutilizedTitle.textContent = `Underutilized Faculty (< ${proRatedTarget.toFixed(1)} Hours Target for ${dayCount} days)`;

            const facultyData = data
                .filter(r => r.Status !== 'Cancellation')
                .reduce((acc, curr) => {
                    const teacher = curr.Status === 'Substitute' ? curr.Substitute_Faculty_Name : curr.faculty_name;
                    const teacherName = teacher ? String(teacher).trim() : null;
                    if (!teacherName) return acc;

                    if (!acc[teacherName]) {
                        acc[teacherName] = {
                            hours: 0,
                            centers: new Set(),
                            subjects: new Set()
                        };
                    }

                    acc[teacherName].hours += safeParseFloat(curr.LectureDuration);
                    if (curr.branch_name) acc[teacherName].centers.add(getCanonicalCenterName(curr.branch_name));
                    if (curr.Expertise) acc[teacherName].subjects.add(String(curr.Expertise).trim());

                    return acc;
                }, {});
            
            const underutilized = Object.entries(facultyData)
                .map(([name, data]) => ({ name, ...data }))
                .filter(faculty => faculty.hours > 0 && faculty.hours < proRatedTarget)
                .sort((a, b) => a.hours - b.hours);

            if (underutilized.length === 0) {
                underutilizedListContainer.innerHTML = `<div class="no-data-message h-full">No underutilized faculty found for this period.</div>`;
                return;
            }

            underutilizedListContainer.innerHTML = `
                <div class="grid grid-cols-3 gap-x-4 text-xs font-semibold text-gray-500 border-b pb-2 mb-2 px-2">
                    <span>FACULTY NAME</span>
                    <span>CENTERS & SUBJECTS</span>
                    <span class="text-right">TOTAL HOURS TAUGHT</span>
                </div>
                <ul class="space-y-1">
                    ${underutilized.map(faculty => `
                        <li class="grid grid-cols-3 gap-x-4 items-center text-sm p-2 rounded-md hover:bg-gray-50">
                            <span class="font-medium text-gray-800 truncate" title="${faculty.name}">${faculty.name}</span>
                            <div class="text-xs text-gray-600">
                                <div class="truncate" title="Centers: ${Array.from(faculty.centers).join(', ')}"><strong>Centers:</strong> ${Array.from(faculty.centers).join(', ') || 'N/A'}</div>
                                <div class="truncate" title="Subjects: ${Array.from(faculty.subjects).join(', ')}"><strong>Subjects:</strong> ${Array.from(faculty.subjects).join(', ') || 'N/A'}</div>
                            </div>
                            <span class="font-bold text-red-600 text-right">${faculty.hours.toFixed(1)} hrs</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        function renderOverutilizedFaculty(data, proRatedTarget, dayCount) {
            overutilizedTitle.textContent = `Overutilized Faculty (> ${proRatedTarget.toFixed(1)} Hours Target for ${dayCount} days)`;

            const facultyData = data
                .filter(r => r.Status !== 'Cancellation')
                .reduce((acc, curr) => {
                    const teacher = curr.Status === 'Substitute' ? curr.Substitute_Faculty_Name : curr.faculty_name;
                    const teacherName = teacher ? String(teacher).trim() : null;
                    if (!teacherName) return acc;

                    if (!acc[teacherName]) {
                        acc[teacherName] = {
                            hours: 0,
                            centers: new Set(),
                            subjects: new Set()
                        };
                    }

                    acc[teacherName].hours += safeParseFloat(curr.LectureDuration);
                    if (curr.branch_name) acc[teacherName].centers.add(getCanonicalCenterName(curr.branch_name));
                    if (curr.Expertise) acc[teacherName].subjects.add(String(curr.Expertise).trim());

                    return acc;
                }, {});

            const overutilized = Object.entries(facultyData)
                .map(([name, data]) => ({ name, ...data }))
                .filter(faculty => faculty.hours > proRatedTarget)
                .sort((a, b) => b.hours - a.hours);

            if (overutilized.length === 0) {
                overutilizedListContainer.innerHTML = `<div class="no-data-message h-full">No overutilized faculty found for this period.</div>`;
                return;
            }

            overutilizedListContainer.innerHTML = `
                <div class="grid grid-cols-3 gap-x-4 text-xs font-semibold text-gray-500 border-b pb-2 mb-2 px-2">
                    <span>FACULTY NAME</span>
                    <span>CENTERS & SUBJECTS</span>
                    <span class="text-right">TOTAL HOURS TAUGHT</span>
                </div>
                <ul class="space-y-1">
                    ${overutilized.map(faculty => `
                        <li class="grid grid-cols-3 gap-x-4 items-center text-sm p-2 rounded-md hover:bg-gray-50">
                            <span class="font-medium text-gray-800 truncate" title="${faculty.name}">${faculty.name}</span>
                            <div class="text-xs text-gray-600">
                                <div class="truncate" title="Centers: ${Array.from(faculty.centers).join(', ')}"><strong>Centers:</strong> ${Array.from(faculty.centers).join(', ') || 'N/A'}</div>
                                <div class="truncate" title="Subjects: ${Array.from(faculty.subjects).join(', ')}"><strong>Subjects:</strong> ${Array.from(faculty.subjects).join(', ') || 'N/A'}</div>
                            </div>
                            <span class="font-bold text-green-600 text-right">${faculty.hours.toFixed(1)} hrs</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }
        
        function renderChart(chartId, type, data, options, plugins = []) {
            const canvas = document.getElementById(chartId);
            const noDataEl = document.getElementById(`${chartId}-no-data`);
            const hasData = data.labels && data.labels.length > 0;
            
            if (canvas) canvas.style.display = hasData ? 'block' : 'none';
            if (noDataEl) noDataEl.style.display = hasData ? 'none' : 'flex';

            const ctx = canvas.getContext('2d');
            if (chartInstances[chartId]) chartInstances[chartId].destroy();
            
            if (!hasData) return;
            
            chartInstances[chartId] = new Chart(ctx, { type, data, options, plugins });
        }
        
        const verticalBarOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { labels: { color: '#4b5563' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.formattedValue}`;
                        }
                    }
                },
                datalabels: { display: false }
            },
            scales: {
                y: { ticks: { color: '#6b7280', beginAtZero: true }, grid: { color: '#e5e7eb' }, suggestedMax: 10 },
                x: { ticks: { color: '#6b7280' }, grid: { display: false } }
            }
        };

        const horizontalBarOptions = {
             responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { 
                legend: { labels: { color: '#4b5563' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.formattedValue}`;
                        }
                    }
                },
                datalabels: { display: false }
            },
            scales: {
                x: { ticks: { color: '#6b7280', beginAtZero: true }, grid: { color: '#e5e7eb' }, suggestedMax: 10 },
                y: { ticks: { color: '#6b7280' }, grid: { display: false } }
            }
        };

        function renderClassesByCenterChart(data) {
            const dataByCenter = data.reduce((acc, curr) => {
                const center = curr.branch_name ? getCanonicalCenterName(curr.branch_name) : null;
                if (!center) return acc;
                if (!acc[center]) acc[center] = { planned: 0, taken: 0 };
                acc[center].planned++;
                if (curr.Status !== 'Cancellation') acc[center].taken++;
                return acc;
            }, {});
            const sortedCenters = Object.entries(dataByCenter).sort((a, b) => b[1].planned - a[1].planned);
            
            renderChart('classesByCenterChart', 'bar', {
                labels: sortedCenters.map(e => e[0]),
                datasets: [
                    { label: 'Classes Taken', data: sortedCenters.map(e => e[1].taken), backgroundColor: '#4f46e5' },
                    { label: 'Classes Planned', data: sortedCenters.map(e => e[1].planned), backgroundColor: '#d1d5db' }
                ]
            }, verticalBarOptions);
        }
        
        function renderHoursChart(data) {
            const kpis = calculateKPIs(data);
            const hasData = kpis.taughtHours > 0 || kpis.cancelledHours > 0;
            toggleNoDataMessage('hoursChart', hasData);
            if (!hasData) return;

            const options = { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { labels: { color: '#4b5563' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0.0%';
                                return `${label}: ${value.toFixed(1)} hrs (${percentage})`;
                            }
                        }
                    },
                    datalabels: {
                         formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (value*100 / sum).toFixed(1)+"%";
                            return percentage;
                        },
                        color: '#fff',
                    }
                } 
            };

            renderChart('hoursChart', 'doughnut', {
                labels: ['Hours Taught', 'Hours Cancelled'],
                datasets: [{
                    data: [kpis.taughtHours, kpis.cancelledHours],
                    backgroundColor: ['#4f46e5', '#f59e0b'],
                    borderColor: '#ffffff',
                    hoverOffset: 4
                }]
            }, options);
        }
        
        function renderSubstitutesLeaderboard(data) {
            const subsByTeacher = data
                .filter(r => r.Status === 'Substitute' && r.Substitute_Faculty_Name)
                .reduce((acc, curr) => {
                    const teacherName = String(curr.Substitute_Faculty_Name).trim();
                    if (teacherName) acc[teacherName] = (acc[teacherName] || 0) + 1;
                    return acc;
                }, {});
            const sorted = Object.entries(subsByTeacher).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            renderChart('substitutesChart', 'bar', {
                labels: sorted.map(t => t[0]),
                datasets: [{ label: 'Substitute Classes', data: sorted.map(t => t[1]), backgroundColor: '#3b82f6' }]
            }, horizontalBarOptions);
        }
        
        function renderCancellationHotspot(data) {
            const cancelsByTeacher = data
                .filter(r => r.Status === 'Cancellation' && r.faculty_name)
                .reduce((acc, curr) => {
                    const teacherName = String(curr.faculty_name).trim();
                    if(teacherName) acc[teacherName] = (acc[teacherName] || 0) + 1;
                    return acc;
                }, {});
            const sorted = Object.entries(cancelsByTeacher).sort((a, b) => b[1] - a[1]).slice(0, 10);

            renderChart('cancellationHotspotChart', 'bar', {
                labels: sorted.map(t => t[0]),
                datasets: [{ label: 'Classes Cancelled', data: sorted.map(t => t[1]), backgroundColor: '#ef4444' }]
            }, horizontalBarOptions);
        }

        function renderTrendChart(data) {
            const trendData = data.reduce((acc, curr) => {
                if (!curr.LectureDate) return acc;
                const lectureDate = new Date(curr.LectureDate);
                if (isNaN(lectureDate.getTime())) return acc;
                
                const date = lectureDate.toISOString().split('T')[0];
                if (!acc[date]) acc[date] = { cancelled: 0, substituted: 0 };
                if (curr.Status === 'Cancellation') acc[date].cancelled++;
                if (curr.Status === 'Substitute') acc[date].substituted++;
                return acc;
            }, {});
            const sortedDates = Object.keys(trendData).sort();
            
            renderChart('trendChart', 'line', {
                labels: sortedDates,
                datasets: [
                    { label: 'Cancellations', data: sortedDates.map(d => trendData[d].cancelled), borderColor: '#ef4444', tension: 0.1, fill: false },
                    { label: 'Substitutions', data: sortedDates.map(d => trendData[d].substituted), borderColor: '#3b82f6', tension: 0.1, fill: false }
                ]
            }, verticalBarOptions);
        }

        function renderCenterCancellationRate(data) {
             const byCenter = data.reduce((acc, curr) => {
                const center = curr.branch_name ? getCanonicalCenterName(curr.branch_name) : null;
                if(!center) return acc;
                if (!acc[center]) acc[center] = { total: 0, cancelled: 0 };
                acc[center].total++;
                if (curr.Status === 'Cancellation') acc[center].cancelled++;
                return acc;
            }, {});

            const rates = Object.entries(byCenter).map(([center, counts]) => ({
                center,
                rate: counts.total > 0 ? (counts.cancelled / counts.total) * 100 : 0
            })).sort((a, b) => b.rate - a.rate);
            
            renderChart('centerCancellationRateChart', 'bar', {
                labels: rates.map(c => c.center),
                datasets: [{ 
                    label: 'Cancellation Rate', 
                    data: rates.map(c => c.rate.toFixed(1)), 
                    backgroundColor: '#f97316' 
                }]
            }, { ...verticalBarOptions, plugins: { ...verticalBarOptions.plugins, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}%` } } } });
        }

        function renderUtilizationChart(taughtHoursByTeacher, proRatedTarget) {
            const sortedTeachers = Object.entries(taughtHoursByTeacher)
                .sort((a, b) => b[1] - a[1]);
            
            utilizationChartTitle.textContent = `Faculty Utilization (vs Pro-rated Target of ${proRatedTarget.toFixed(1)} hrs)`;

            const utilizationChartWrapper = document.getElementById('utilization-chart-wrapper');
            const newHeight = Math.max(550, sortedTeachers.length * 30);
            utilizationChartWrapper.style.height = `${newHeight}px`;

            const options = {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const hours = context.raw.toFixed(1);
                                return `Taught: ${hours} hrs`;
                            },
                            afterBody: function(context) {
                                const hours = context[0].raw;
                                const shortfall = (proRatedTarget - hours);
                                const lines = [`Target: ${proRatedTarget.toFixed(1)} hrs`];
                                if (shortfall > 0) {
                                    lines.push(`Shortfall: ${shortfall.toFixed(1)} hrs`);
                                }
                                return lines;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end', 
                        offset: 8,
                        formatter: (value) => value.toFixed(1) + ' hrs',
                        color: '#374151',
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: '#6b7280', beginAtZero: true }, grid: { color: '#e5e7eb' }, suggestedMax: proRatedTarget * 1.2 },
                    y: { ticks: { color: '#6b7280' }, grid: { display: false } }
                }
            };
            
            renderChart('utilizationChart', 'bar', {
                labels: sortedTeachers.map(t => t[0]),
                datasets: [{
                    label: 'Total Hours Taught',
                    data: sortedTeachers.map(t => t[1]),
                    backgroundColor: sortedTeachers.map(t => t[1] < proRatedTarget ? '#ef4444' : '#10b981'),
                }]
            }, options);
        }
        
        function exportUtilizationDataToCSV() {
            if (utilizationDataForExport.length === 0) {
                alert('No utilization data to export for the selected filters.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Teacher Name,Target Hours,Achieved Hours,Remark\n"; // Header row

            utilizationDataForExport.forEach(row => {
                const rowArray = [`"${row.name}"`, row.target, row.achieved, row.remark];
                csvContent += rowArray.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `faculty_utilization_report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- NEW REVAMPED EXPORT FUNCTION ---
        async function exportMasterReport() {
            const originalButtonHTML = exportReportButton.innerHTML;
            exportReportButton.disabled = true;
            exportReportButton.innerHTML = 'Exporting...';

            try {
                const { startDate, endDate, center, subject, teacher } = getFilterValues();
                const filteredData = filterData(startDate, endDate, center, subject, teacher);

                if (filteredData.length === 0) {
                    alert('No data available for the selected filters to export.');
                    return;
                }

                // 1. Prepare "Cancellations & Substitutions" data
                const cancellationSubData = filteredData
                    .filter(row => row.Status === 'Cancellation' || row.Status === 'Substitute')
                    .map(row => {
                        let remark = 'N/A';
                        if (row.Status === 'Cancellation') {
                            remark = `Class cancelled by ${row.faculty_name || 'N/A'}`;
                        } else if (row.Status === 'Substitute') {
                            remark = `Substituted by ${row.Substitute_Faculty_Name || 'N/A'}`;
                        }
                        return {
                            "Date": row.LectureDate ? new Date(row.LectureDate).toLocaleDateString('en-CA') : 'N/A',
                            "Center": getCanonicalCenterName(row.branch_name) || 'N/A',
                            "Status": row.Status || 'N/A',
                            "Original Teacher": row.faculty_name || 'N/A',
                            "Substitute Teacher": row.Substitute_Faculty_Name || 'N/A',
                            "Subject": row.Expertise || 'N/A',
                            "Lecture Duration (Hrs)": safeParseFloat(row.LectureDuration),
                            "Remark": remark
                        };
                    });
                
                // 2. Prepare "Faculty Utilization" data (already available)
                // Recompute utilization (target/achieved) from the same filtered data and date range
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const diffTime = Math.abs(endDateObj - startDateObj);
                const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const monthCount = dayCount / 30.4375; // Average days in a month
                const proRatedTarget = MONTHLY_HOURS_TARGET * monthCount;

                const taughtHoursByTeacher = filteredData
                    .filter(r => r.Status !== 'Cancellation')
                    .reduce((acc, curr) => {
                        const teacher = curr.Status === 'Substitute' ? curr.Substitute_Faculty_Name : curr.faculty_name;
                        const teacherName = teacher ? String(teacher).trim() : null;
                        if (teacherName) acc[teacherName] = (acc[teacherName] || 0) + safeParseFloat(curr.LectureDuration);
                        return acc;
                    }, {});

                const utilizationDataForExportLocal = Object.entries(taughtHoursByTeacher).map(([name, totalHours]) => ({
                    name,
                    target: proRatedTarget.toFixed(2),
                    achieved: totalHours.toFixed(2),
                    remark: totalHours >= proRatedTarget ? 'Met Target' : 'Below Target'
                })).sort((a,b) => b.achieved - a.achieved);

                const utilizationSheetData = utilizationDataForExportLocal.map(item => ({
                    "Teacher Name": item.name,
                    "Target Hours": parseFloat(item.target),
                    "Achieved Hours": parseFloat(item.achieved),
                    "Remark": item.remark
                }));

                // 3. Prepare "Raw Data" sheet
                // A simple deep copy to avoid modifying the original data
                const rawDataSheet = JSON.parse(JSON.stringify(filteredData));

                // Create workbook and worksheets
                const wb = XLSX.utils.book_new();
                const wsCancellations = XLSX.utils.json_to_sheet(cancellationSubData);
                const wsUtilization = XLSX.utils.json_to_sheet(utilizationSheetData);
                const wsRawData = XLSX.utils.json_to_sheet(rawDataSheet);

                // Add worksheets to the workbook
                XLSX.utils.book_append_sheet(wb, wsCancellations, "Cancellations & Substitutions");
                XLSX.utils.book_append_sheet(wb, wsUtilization, "Faculty Utilization");
                XLSX.utils.book_append_sheet(wb, wsRawData, "Raw Data");

                // Trigger the download
                const fileName = `Master_Faculty_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

            } catch (error) {
                console.error("Error exporting master report:", error);
                alert("Sorry, there was an error generating the Excel report.");
            } finally {
                exportReportButton.disabled = false;
                exportReportButton.innerHTML = originalButtonHTML;
            }
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        startDateInput.addEventListener('change', updateDashboard);
        endDateInput.addEventListener('change', updateDashboard);
        teacherFilter.addEventListener('change', updateDashboard);
        subjectFilter.addEventListener('change', () => {
            populateTeacherFilter();
            updateDashboard();
        });
        centerFilter.addEventListener('change', () => {
            populateSubjectFilter();
            subjectFilter.value = 'all';
            populateTeacherFilter();
            teacherFilter.value = 'all';
            updateDashboard();
        });
        resetButton.addEventListener('click', resetFiltersAndReload);
        // UPDATED: Pointing to the new export function
        exportReportButton.addEventListener('click', exportMasterReport);
        exportUtilizationButton.addEventListener('click', exportUtilizationDataToCSV);
        if (logoutButton) logoutButton.addEventListener('click', logout);

        window.onload = loadData;
    </script>
</body>
</html>